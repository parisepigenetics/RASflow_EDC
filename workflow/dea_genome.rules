import pandas as pd
import numpy as np

configfile: "configs/config_main.yaml"


counter = config["COUNTER"]
input_path = config["FINALOUTPUT"] + "/" + config["PROJECT"] + "/genome/countFile_"+counter
output_path = config["FINALOUTPUT"] + "/" + config["PROJECT"] + "/genome/dea_"+counter


samples = np.array(pd.read_table(config["METAFILE"], header = 0)['sample'])
groups = np.unique(np.array(pd.read_table(config["METAFILE"], header = 0)['group']))
control = config["CONTROL"][0]
treat = config["TREAT"][0]
tool = config["DEATOOL"]
main_path = config["MAINPATH"]

if tool == "edgeR" :
    rule all:
        input:
            normControl = output_path + "/Norm_edgeR/" + control + "_gene_norm.tsv",
            dea = output_path + "/DEA_edgeR/" + "dea_" + control + "_" + treat + ".tsv"

elif tool == "DESeq2" :
    rule all:
        input:
            normControl = output_path + "/Norm_DESeq2/" + control + "_gene_norm.tsv",
            dea = output_path + "/DEA_DESeq2/" + "dea_" + control + "_" + treat + ".tsv"

rule combineSamples:
    input:
        sampleCount = expand(input_path + "/{sample}_count.tsv", sample = samples),
        metafile = config["METAFILE"]
    output:
        groupCount = expand(output_path + "/countGroup/{group}_gene_count.tsv", group = groups)
    conda:
        "env.yaml"
    params:
        mp = main_path
    shell:
        "python {params.mp}scripts/combine2group_genome.py"

if tool == "edgeR" : 
    rule DEA:
        input:
            groupCount = expand(output_path + "/countGroup/{group}_gene_count.tsv", group = groups)
        output:
            normControl = output_path + "/Norm_edgeR/" + control + "_gene_norm.tsv",
            normTreat = output_path + "/Norm_edgeR/" + treat + "_gene_norm.tsv",
            dea = output_path + "/DEA_edgeR/" + "dea_" + control + "_" + treat + ".tsv",
            deg = output_path + "/DEA_edgeR/" + "deg_" + control + "_" + treat + ".tsv"
        conda:
            "env.yaml"
        params:
            mp = main_path
        shell:
            "Rscript {params.mp}scripts/dea_genome.R"
            
if tool == "DESeq2" : 
    rule DEA:
        input:
            groupCount = expand(output_path + "/countGroup/{group}_gene_count.tsv", group = groups)
        output:
            normControl = output_path + "/Norm_DESeq2/" + control + "_gene_norm.tsv",
            normTreat = output_path + "/Norm_DESeq2/" + treat + "_gene_norm.tsv",
            dea = output_path + "/DEA_DESeq2/" + "dea_" + control + "_" + treat + ".tsv",
            deg = output_path + "/DEA_DESeq2/" + "deg_" + control + "_" + treat + ".tsv"
        conda:
            "env.yaml"
        params:
            mp = main_path
        shell:
            "Rscript {params.mp}scripts/dea_genome.R"
