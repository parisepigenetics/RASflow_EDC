import pandas as pd
import numpy as np

configfile: "configs/config_main.yaml"


counter = config["COUNTER"]
mapper = config["ALIGNER"]
tool = config["DEATOOL"]
input_path = config["RESULTPATH"] + "/" + config["PROJECT"] + "/mapping_" + mapper + "/counting_"+counter
output_path = input_path + "/DEA_"+tool+"/" 


samples = np.array(pd.read_table(config["METAFILE"], header = 0)['sample'])
groups = np.unique(np.array(pd.read_table(config["METAFILE"], header = 0)['group']))
control = config["CONTROL"][0]
treat = config["TREAT"][0]
main_path = config["MAINPATH"]

rule all:
    input: 
        dea = output_path + "Tables/dea_" + control + "_" + treat + ".tsv",
        glimma = output_path + "Report/Glimma/MDPlot_"+ control + "_" + treat + ".html",
        norm = output_path + "Tables/"+ control + "_" + treat + "_NormCounts.tsv",
        pca = input_path + "/PCA.pdf",
        volcano = output_path + "Report/plots/volcano_plot_" + control + "_" + treat + ".pdf"
       
rule PCA:
    input:
        countF = expand(input_path +"/countTables/{sample}_count.tsv", sample=samples)
    output:
        pca = input_path + "/PCA.pdf"
    conda:
        "env.yaml"
    params:
        input_path = input_path,
        mp = main_path
    shell:
        "Rscript {params.mp}scripts/pca.R {params.input_path}"
        
        
rule combineSamples:
    input:
        countF = expand(input_path +"/countTables/{sample}_count.tsv", sample=samples)
    output:
        groupCount = expand(input_path + "/countTables/{group}_counts.tsv", group = groups)
    conda:
        "env.yaml"
    params:
        mp = main_path
    shell:
        "python {params.mp}scripts/combine2group_genome.py"
        
        
rule DEA:
    input:
        groupCount = expand(input_path + "/countTables/{group}_counts.tsv", group = groups)
    output:
        dea = output_path + "Tables/dea_" + control + "_" + treat + ".tsv",
        glimma = output_path + "Report/Glimma/MDPlot_"+ control + "_" + treat + ".html",
        norm = output_path + "Tables/"+ control + "_" + treat + "_NormCounts.tsv",
        volcano = output_path + "Report/plots/volcano_plot_" + control + "_" + treat + ".pdf"
    conda:
        "env.yaml"
    params:
        mp = main_path,
        output_path = output_path,
        counts_path = input_path + "/countTables/"
    shell:
        "Rscript {params.mp}scripts/dea_genome.R {params.counts_path} {params.output_path}"
