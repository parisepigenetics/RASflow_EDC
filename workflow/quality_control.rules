import pandas as pd
configfile: "config_ongoing_run.yaml"

key = config["KEY"]
input_path = config["READSPATH"]
samples = pd.read_csv(config["METAFILE"], sep = '\t', header = 0)['sample']
end = config["END"]
intermediate_path = config["BIGDATAPATH"] + "/" + config["PROJECT"]
final_path = config["RESULTPATH"] + "/" + config["PROJECT"]

if input_path[0] != "/": 
    import os
    input_path = os.getcwd()+"/"+input_path


rule end:
    input:
        report = final_path + "/fastqc/report_quality_control.html"
        
if end == "pair":
    rule getReads:
        output:
            fw = temp(intermediate_path + "/reads/{sample}_fw.fastq.gz"),
            rv = temp(intermediate_path + "/reads/{sample}_rv.fastq.gz")
        params:
            key = key,
            input_path = input_path
        run:
            #shell("scp -i {params.key} {params.input_path}/{wildcards.sample}_*R1*.f*q.gz {output.fw}"),
            #shell("scp -i {params.key} {params.input_path}/{wildcards.sample}_*R2*.f*q.gz {output.rv}")
            shell("echo creating link {params.input_path}/{wildcards.sample}_*R2*.f*q.gz {output.rv}"),
            shell("ln -s {params.input_path}/{wildcards.sample}_*R2*.f*q.gz {output.rv}"),
            shell("echo creating link {params.input_path}/{wildcards.sample}_*R1*.f*q.gz {output.fw}"),
            shell("ln -s {params.input_path}/{wildcards.sample}_*R1*.f*q.gz {output.fw}")

            
    rule qualityControl:
        input:
            fw = intermediate_path + "/reads/{sample}_fw.fastq.gz",
            rv = intermediate_path + "/reads/{sample}_rv.fastq.gz"
        output:
            fastqc_fw = final_path + "/fastqc/{sample}_fw_fastqc.html",
            fastqc_rv = final_path + "/fastqc/{sample}_rv_fastqc.html"
        conda:
            "env.yaml"
        params:
            outputpath = final_path + "/fastqc"
        shell:
            "fastqc -t 2 -o {params.outputpath} {input.fw} {input.rv}"
            
    rule summaryReport:
        input:
            fastqc_fw = expand(final_path + "/fastqc/{sample}_fw_fastqc.html", sample = samples),
            fastqc_rv = expand(final_path + "/fastqc/{sample}_rv_fastqc.html", sample = samples)
        output:
            report = final_path + "/fastqc/report_quality_control.html",
            folder = directory(final_path + "/fastqc/report_quality_control_data")
        conda:
            "env.yaml"
        params:
            path = final_path + "/fastqc"
        shell:
            "rm -fr {output.report} {output.folder} && multiqc {params.path} --filename {output.report}"
            
else:
    rule getReads:
        output:
            read = temp(intermediate_path + "/reads/{sample}.fastq.gz")
        params:
            key = key,
            input_path = input_path
        run:
            shell("scp -i {params.key} {params.input_path}/{wildcards.sample}*.f*q.gz {output.read}")
            
    rule qualityControl:
        input:
            read = intermediate_path + "/reads/{sample}.fastq.gz"
        output:
            fastqc = final_path + "/fastqc/{sample}_fastqc.html"
        conda:
            "env.yaml"
        params:
            outputpath = final_path + "/fastqc"
        shell:
            "fastqc -o {params.outputpath} {input.read}"
            
    rule summaryReport:
        input:
            fastqc = expand(final_path + "/fastqc/{sample}_fastqc.html", sample = samples)
        output:
            report = final_path + "/fastqc/report_quality_control.html",
            folder = directory(final_path + "/fastqc/report_quality_control_data")
        conda:
            "env.yaml"
        params:
            path = final_path + "/fastqc"
        shell:
            "rm -fr {output.report} {output.folder} && multiqc {params.path} --filename {output.report}"
    
